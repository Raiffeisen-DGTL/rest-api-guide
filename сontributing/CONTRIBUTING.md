## Как внести вклад в API Best Practices
Мы рады любым предложениям по улучшению стандартов API нашего банка. Этот документ описывает процесс внесения изменений в API Guide.

- [Как внести вклад в API Best Practices](#как-внести-вклад-в-api-best-practices)
  - [Общий процесс внесения изменений](#общий-процесс-внесения-изменений)
  - [Детальный процесс](#детальный-процесс)
    - [1. Ознакомление с текущим гайдом](#1-ознакомление-с-текущим-гайдом)
    - [2. Создание Issue (рекомендуется)](#2-создание-issue-рекомендуется)
    - [3. Подготовка Merge Request](#3-подготовка-merge-request)
    - [4. Процесс рассмотрения](#4-процесс-рассмотрения)
    - [5. Критерии принятия изменений](#5-критерии-принятия-изменений)
  - [Процесс разработки автоматизированных правил Spectral](#процесс-разработки-автоматизированных-правил-spectral)
    - [Введение](#введение)
    - [Как начать работу](#как-начать-работу)
    - [Структура проекта](#структура-проекта)
    - [Внесение изменений](#внесение-изменений)
      - [Добавление новых правил](#добавление-новых-правил)
      - [Добавление пользовательских функций](#добавление-пользовательских-функций)
      - [Создание тестов](#создание-тестов)
    - [Проверка изменений](#проверка-изменений)
    - [Рекомендации](#рекомендации)
  - [Команды Maintainers](#команды-maintainers)
  - [Жизненный цикл правил](#жизненный-цикл-правил)
  - [Контакты](#контакты)
  - [Лицензия](#лицензия)

### Общий процесс внесения изменений
1. Ознакомьтесь с текущей версией стандартов API в [rules.md](rules.md)
2. [Создайте Issue](https://gitlabci.raiffeisen.ru/cib/api-guide/-/issues) для обсуждения предлагаемых изменений (опционально, но рекомендуется)
3. Подготовьте Merge Request с предлагаемыми изменениями
4. Дождитесь рассмотрения от [команды maintainers](#команды-maintainers)
5. Внесите правки (если потребуется) по результатам обсуждения
6. После одобрения ваши изменения будут включены в основную ветку

### Детальный процесс

#### 1. Ознакомление с текущим гайдом
Перед предложением изменений, пожалуйста, внимательно ознакомьтесь с:
- Текущей версией [API Guide](rules.md)
- [Открытыми и закрытыми Issue](https://gitlabci.raiffeisen.ru/cib/api-guide/-/issues), чтобы убедиться, что ваше предложение не дублирует существующие
- Историей изменений гайда за последнее время

#### 2. Создание Issue (рекомендуется)
Перед созданием Merge Request рекомендуется сначала [создать issue](https://gitlabci.raiffeisen.ru/cib/api-guide/-/issues) для обсуждения предлагаемых изменений:
- Используйте шаблон "API Guide Change Proposal"
- Четко опишите проблему или улучшение, которое вы предлагаете
- Укажите обоснование для предлагаемых изменений
- По возможности, приведите примеры использования

#### 3. Подготовка Merge Request
Когда вы готовы предложить изменения:
1. Создайте новую ветку из main с названием, отражающим суть изменений
```
git checkout -b add-new-rule-for-authentication
```
2. Внесите изменения в соответствующие файлы гайда
3. Если вы добавляете новое правило, следуйте [установленному формату](rule-format.md):
4. Создайте Merge Request
5. В описании MR укажите:
	- Ссылку на Issue (если он был создан)
	- Краткое описание изменений
	- Обоснование изменений
	- Связанную документацию или ресурсы
6. Отправьте ссылку на Merge Request в чат [~cib_api_first](https://mattermost.raiffeisen.ru/raiffeisenbank/channels/cib_api_first) 

#### 4. Процесс рассмотрения
После создания Merge Request:
1. Maintainers от двух команд рассмотрят ваши изменения
2. В процессе обсуждения могут быть запрошены дополнительные комментарии или изменения
3. Для принятия изменений требуется положительное решение от всех [команд maintainers](#команды-maintainers)

#### 5. Критерии принятия изменений
Предложенные изменения должны соответствовать следующим критериям:
- Не противоречить общей концепции API Guide
- Быть достаточно обоснованными и актуальными
- Быть практически применимыми
- Иметь четкое и понятное описание
- По возможности, включать примеры автоматизации проверки

### Процесс разработки автоматизированных правил Spectral

#### Введение

Для изменения автоматизированных правил в директории [spectral](../spectral/) следуйте этой инструкции.

#### Как начать работу

1. Клонируйте репозиторий.  
2. Установите зависимости.   
   ```bash
   npm install
   ```

#### Структура проекта

Проект организован следующим образом:

- `rules/` - содержит наборы правил
    - `required/` - обязательные правила, блокируют публикацию на портал
    - `base/` - расширенный набор правил
- `functions/` - пользовательские функции, используемые в правилах
- `tests/` - тесты для проверки правил

#### Внесение изменений

##### Добавление новых правил

1. Определите, в какой каталог нужно добавить новое правило:
    - Для набора обязательных правил: `rules/required/`
    - Для расширенного набора правил: `rules/base/`

2. Создайте новую ветку на основе main
3. Создайте новый файл правила с расширением `.yaml`
4. Напишите правило в формате Spectral:
   ```yaml
   rules:
     имя-правила:
       description: "Описание правила"
       recommended: true
       severity: error
       given: "$.paths.*.*"
       then:
         field: summary
         function: truthy
   ```

5. Добавьте тесты для нового правила в каталог `tests/`

##### Добавление пользовательских функций

1. Создайте функцию в каталоге `functions/`
2. Функции должны быть написаны на JavaScript
3. Импортируйте функцию в соответствующие правила

##### Создание тестов

1. Создайте тестовый файл в каталоге `tests/`
2. Используйте формат Jest для тестирования
3. Проверяйте как положительные, так и отрицательные сценарии

#### Проверка изменений

Перед отправкой изменений убедитесь, что:

1. Все тесты проходят:
   ```bash
   npm test
   ```

2. Код соответствует стандартам линтинга:
   ```bash
   npm run lint
   ```

3. Код отформатирован:
   ```bash
   npm run format
   ```

4. Сборка правил работает корректно:
   ```bash
   ./build-rulesets.sh
   ```
   В папке spectral, должны обновиться два файла required-ruleset.yaml и base-ruleset.yaml

5. Сформировать MR по [примеру](#3-подготовка-merge-request)

#### Рекомендации

- Следуйте существующему стилю кода
- Добавляйте тесты для новых функций
- Проверяйте, что ваши изменения не ломают существующую функциональность

### Команды Maintainers
Решения о принятии изменений принимаются двумя командами maintainers:
- [Команда Raif API](https://insider.raiffeisen.ru/agile-team/180)
- [Команда Raif Pay](https://insider.raiffeisen.ru/employees/dashboard/functional-team/923)

### Жизненный цикл правил
Каждое правило в гайде имеет свой жизненный цикл:
1. Предложено - правило предложено, но еще не принято
2. Принято - правило утверждено и включено в гайд
3. Устарело - правило помечено как устаревшее, но еще действует
4. Удалено - правило больше не действует
### Контакты
Если у вас возникли вопросы, вы можете связаться с командами maintainers:
- Команда API Standards: #api-standards в корпоративном Slack
- Команда Bank API: #bank-api в корпоративном Slack
### Лицензия
Внося изменения в API-гайд, вы соглашаетесь с тем, что ваш вклад будет доступен под той же внутренней лицензией, что и сам гайд.