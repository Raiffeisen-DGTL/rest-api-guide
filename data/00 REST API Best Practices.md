# REST API Best Practices

[[_TOC_]]

Цель гайда - улучшить разработку **новых** версий API и сделать его более единообразным для удобства потребителей.

Существующие контракты полностью сохраняются.

## Общие рекомендации

Это первая версия гайда по лучшим практикам REST API

## Формат даты-времени

Используем формат [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601).
Избегаем использования времени / микросекунд / миллисекунд если в этом нет явной необходимости.
Принимаем в запросах время и в UTC, и с указанием чаcового пояса, возвращаем в ответе строго в формате UTC. Если в запросе нет признака UTC или указания часового пояса - возвращаем ошибку валидации.

Паттерны для даты-времени **YYYY-MM-DDThh:mm:ssZ** / **YYYY-MM-DDThh:mm:ss±hh:mm**.

Паттерн для даты **YYYY-MM-DD**.

Используем названия полей вида someData как для даты, так и для даты-времени.

$`\textcolor{green}{\text{Хорошие примеры:}}`$  

```json
"birthDate": "1980-01-30"
"qrExpirationDate": "2023-07-22T09:14:38+03:00"
"createDate": "2019-08-24T14:15:22Z"
"transactionDate": "2022-12-08T13:21:04.631543+03:00" 
```

$`\textcolor{red}{\text{Плохие примеры:}}`$  

```json
"birthday": "1980.01.30"
"dateTime": "2020-01-15T16:01:49.043924"
"createDateTime": "2011-03-01T14:15:22Z"
```

## Формат стран, валют и сумм

**_NOTE:_** Этот раздел в процессе обсуждения

Формат стран [ISO 3166, UPPER ALPHA-2](https://en.wikipedia.org/wiki/ISO_3166-1).

Формат валют [ISO 4217, UPPER ALPHA-3](https://en.wikipedia.org/wiki/ISO_4217).

Суммы указываются как строка с дробным числом (если количество разрядов >0 ), разделитель точка, количество разрядов зависит от валюты.

Необходимо всегда указывать код валюты.

$`\textcolor{green}{\text{Хорошие примеры:}}`$  

```json
"currency": "RUB"
"country": "RU"
"amount": 1110.11
```

$`\textcolor{red}{\text{Плохие примеры:}}`$  

```json
"currency": "643"
"country": "RUS"
"amount": 1200.1
```

## Детализация ошибки в теле ответа

Признаком ошибки являются коды HTTP status code 4xx и 5xx. Не следует возвращать код HTTP 200 для возврата ошибок.

За исключением коммуникационных ошибок типа 502 Bad Gateway, необходимо детализировать ошибку в теле ответа.

Не следует дублировать HTTP status code в теле сообщения.

Поле **“code”** содержит код ошибки вида SOME_ERROR_DETAIL (SCREAMING_SNAKE_CASE style). Рекомендуем посмотреть какие коды ошибок уже используются, чтобы **не дублировать** уже существующие коды с новым именем.

Поле **"message"** - это человеко читаемое поле, содержащие описание ошибки, которые можно выводить пользователю.

Ошибка валидации запроса необходимо возвращать в виде массива в поле "errors".

Рекомендуем возвращать traceId для трассировки в теле ответа, чтобы упростить поиск ошибки при взаимодействии с внешними контрагентами. Предпочительный формат [B3](https://github.com/openzipkin/b3-propagation).

$`\textcolor{green}{\text{Хорошие примеры:}}`$  

```json
{
    "code": "RECEIPT_VALIDATION_FAILED",
    "message": "Чек не прошел валидацию. Причина: {value}",
    "traceId" : "80f198ee56343ba8"
}

{
  "code": "FIELD_KEK_ERROR",
  "message": "Ваши поля отстой",
  "errors": {
    "username": "Описание ошибки",
    "email": "Не прошла валидация почты",
    "password": "Не заполнено"
  },
  "traceId" : "64fe8b2a57d3eff7"
}
```

$`\textcolor{red}{\text{Плохие примеры:}}`$  

```json
{
    "timestamp": "2021-01-01T12:00:27.87+00:20",
    "status": 401,
    "error": "Unauthorized",
    "message": "",
    "path": "/api/cards/v1/callback/settings/"
}

200 OK
{
    "code": "ERROR.ACCOUNT_ALREADY_REGISTERED",
    "message": "Счет 40700000007721511123 уже зарегистрирован для этого юридического лица"
}
```

## Формат URL

**_NOTE:_** Этот раздел в процессе обсуждения

**Среды разделены по доменам:**

https://pay-dev.raif.ru - тестовая среда. Для внутренних тестов.\
https://pay-test.raif.ru - превью, песочница для партнеров.\
https://pay.raif.ru - прод.

**URL path состоит из следующих частей:**

/api - префикс для отличия API от документации, лендинга и т.п. \
/{product} - префикс продукта из справочника, например: report, fiscal, sbp. Должен совпадать с соответствующим разделом документации. Указывается в единстенном числе. \
/v1 - версия всего API продукта. Может находиться только в этой части пути. Нумеруется как: v1, v2, и т.д. \

Других префиксов быть не должно.

В результате URL может выглядеть так:
```
https://pay.raif.ru/api/fiscal/v2/receipts
```

## Версионирование

**_NOTE:_** Этот раздел в процессе обсуждения
